<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<div class="section" id="django-logging">
<h1>Django Logging</h1>
<p>A <a class="reference external" href="https://www.djangoproject.com/">Django</a> library that makes sharding easy, using the <a class="reference external" href="https://en.wikipedia.org/wiki/Consistent_hashing">Consistent Hashing</a> algorithm.</p>
<a class="reference external image-reference" href="https://badge.fury.io/py/django-autoshard"><object data="https://badge.fury.io/py/django-autoshard.svg" type="image/svg+xml">https://badge.fury.io/py/django-autoshard.svg</object></a>
<a class="reference external image-reference" href="https://img.shields.io/pypi/dm/django-autoshard.svg"><object data="https://img.shields.io/pypi/dm/django-autoshard.svg" type="image/svg+xml">https://img.shields.io/pypi/dm/django-autoshard.svg</object></a>
<a class="reference external image-reference" href="https://travis-ci.org/cipriantarta/django-autoshard"><img alt="Build Status" src="https://travis-ci.org/cipriantarta/django-autoshard.svg?branch=master" /></a>
<a class="reference external image-reference" href="https://coveralls.io/github/cipriantarta/django-autoshard?branch=master"><img alt="Coverage Status" src="https://coveralls.io/repos/github/cipriantarta/django-autoshard/badge.svg?branch=master" /></a>
</div>
<div class="section" id="notes">
<h1>Notes</h1>
<p>Writing a general sharding library for all business models is practically impossible, but there are common particularities that apply to most of them.</p>
<p>If you are not familiar with sharding, you should first document yourself on what sharding means and how you could apply it to your own business model. You can start <a class="reference external" href="https://en.wikipedia.org/wiki/Shard_(database_architecture)">here</a>.</p>
<p>This library was written with the following business model in mind.</p>
<p>An application usually has a user account that must be different from other user accounts either by using a unique email address, or username, or other information that can be considered unique across the application.</p>
<p>Each user account will be sharded using that unique constraint and all data that belongs to that user will live on the same shard that the user account does.</p>
<p>You can perhaps customize this business model to fit your own requirements, but the idea of this library was to add sharding to a Django app, with a minimum amount of effort.</p>
<p>The sharding algorithm used by this library is inspired by <a class="reference external" href="http://instagram-engineering.tumblr.com/post/10853187575/sharding-ids-at-instagram">Instagram's sharding solution</a>, but instead of an auto-increment ID and stored procedures, this library uses a RNG for the local ID part. This probably means that when the stars align, you might get a collision if an insert is made in the same millisecond and the RNG gives you the same number.</p>
</div>
<div class="section" id="installation">
<h1>Installation</h1>
<p><code class="python"><span class="name">pip</span> <span class="name">install</span> <span class="name">django</span><span class="operator">-</span><span class="name">autoshard</span></code></p>
<ol class="arabic simple">
<li>Add <code class="python"><span class="name">django_autoshard</span></code> to your INSTALLED_APPS settings like this:</li>
</ol>
<pre class="code python literal-block">
<span class="name">INSTALLED_APPS</span> <span class="operator">=</span> <span class="punctuation">(</span>
    <span class="operator">...</span>
    <span class="literal string">'django_autoshard'</span><span class="punctuation">,</span>
<span class="punctuation">)</span>
</pre>
<ol class="arabic simple" start="2">
<li>Create a new user model that extends the <code class="python"><span class="name">ShardedModel</span></code> and extend all related models from <code class="python"><span class="name">ShardRelatedModel</span></code></li>
</ol>
<pre class="code python literal-block">
<span class="keyword namespace">from</span> <span class="name namespace">django_autoshard.models</span> <span class="keyword namespace">import</span> <span class="name">ShardedModel</span><span class="punctuation">,</span> <span class="name">ShardRelatedModel</span>
<span class="keyword namespace">from</span> <span class="name namespace">django_autoshard.managers</span> <span class="keyword namespace">import</span> <span class="name">ShardedManager</span>


<span class="keyword">class</span> <span class="name class">User</span><span class="punctuation">(</span><span class="name">ShardedModel</span><span class="punctuation">,</span> <span class="name">AbstractUser</span><span class="punctuation">):</span>
    <span class="name">SHARD_KEY</span> <span class="operator">=</span> <span class="literal string">'email'</span>
    <span class="name">objects</span> <span class="operator">=</span> <span class="name">UserManager</span><span class="punctuation">()</span>


<span class="keyword">class</span> <span class="name class">Book</span><span class="punctuation">(</span><span class="name">ShardRelatedModel</span><span class="punctuation">):</span>
    <span class="name">user</span> <span class="operator">=</span> <span class="name">models</span><span class="operator">.</span><span class="name">ForeignKey</span><span class="punctuation">(</span><span class="name">User</span><span class="punctuation">)</span>
</pre>
<ol class="arabic" start="3">
<li><dl class="first docutils">
<dt>Use this model as the default auth model in your <code class="python"><span class="name">settings</span><span class="operator">.</span><span class="name">py</span></code> file.</dt>
<dd><p class="first last"><code class="python"><span class="name">AUTH_USER_MODEL</span><span class="operator">=</span><span class="literal string">'&lt;path.to.your.model&gt;.User'</span></code></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Make sure you have set up the <code class="python"><span class="name">settings</span><span class="operator">.</span><span class="name">DATABASES</span></code> correctly(any Django supported database back-end will work)</dt>
<dd><dl class="first last docutils">
<dt>and add a range of logical shards to each of your configured database node that you want to use for sharding.</dt>
<dd><pre class="code python first last literal-block">
<span class="name">DATABASES</span> <span class="operator">=</span> <span class="punctuation">{</span>
    <span class="literal string">'default'</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="literal string">'ENGINE'</span><span class="punctuation">:</span> <span class="literal string">'django.db.backends.mysql'</span><span class="punctuation">,</span>
        <span class="literal string">'HOST'</span><span class="punctuation">:</span> <span class="literal string">'db_a'</span><span class="punctuation">,</span>
        <span class="literal string">'NAME'</span><span class="punctuation">:</span> <span class="literal string">'my_database'</span><span class="punctuation">,</span>
        <span class="literal string">'USER'</span><span class="punctuation">:</span> <span class="literal string">'root'</span><span class="punctuation">,</span>
        <span class="literal string">'PASSWORD'</span><span class="punctuation">:</span> <span class="literal string">'secretpass'</span><span class="punctuation">,</span>
        <span class="literal string">'RANGE'</span><span class="punctuation">:</span> <span class="name builtin">range</span><span class="punctuation">(</span><span class="literal number integer">10</span><span class="punctuation">),</span>
    <span class="punctuation">},</span>
    <span class="literal string">'DB_B'</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="literal string">'ENGINE'</span><span class="punctuation">:</span> <span class="literal string">'django.db.backends.mysql'</span><span class="punctuation">,</span>
        <span class="literal string">'HOST'</span><span class="punctuation">:</span> <span class="literal string">'db_b'</span><span class="punctuation">,</span>
        <span class="literal string">'NAME'</span><span class="punctuation">:</span> <span class="literal string">'my_database'</span><span class="punctuation">,</span>
        <span class="literal string">'USER'</span><span class="punctuation">:</span> <span class="literal string">'root'</span><span class="punctuation">,</span>
        <span class="literal string">'PASSWORD'</span><span class="punctuation">:</span> <span class="literal string">'secretpass'</span><span class="punctuation">,</span>
        <span class="literal string">'RANGE'</span><span class="punctuation">:</span> <span class="name builtin">range</span><span class="punctuation">(</span><span class="literal number integer">10</span><span class="punctuation">,</span> <span class="literal number integer">20</span><span class="punctuation">),</span>
    <span class="punctuation">},</span>
<span class="punctuation">}</span>
</pre>
</dd>
</dl>
</dd>
</dl>
</li>
<li><p class="first">Run <code class="python"><span class="name">python</span> <span class="name">manage</span><span class="operator">.</span><span class="name">py</span> <span class="name">migrate</span></code></p>
</li>
<li><p class="first">Run <code class="python"><span class="name">python</span> <span class="name">manage</span><span class="operator">.</span><span class="name">py</span> <span class="name">create_shards</span></code></p>
</li>
<li><p class="first">Run <code class="python"><span class="name">python</span> <span class="name">manage</span><span class="operator">.</span><span class="name">py</span> <span class="name">migrate_shards</span></code></p>
</li>
<li><p class="first">Run <code class="python"><span class="name">python</span> <span class="name">manage</span><span class="operator">.</span><span class="name">py</span> <span class="name">drop_constraints</span></code></p>
</li>
</ol>
</div>
<div class="section" id="commands">
<h1>Commands</h1>
<dl class="docutils">
<dt>Management Commands that come with this library:</dt>
<dd><ol class="first last arabic">
<li><dl class="first docutils">
<dt>create_shards:</dt>
<dd><ul class="first last simple">
<li>this command will create all the logical shards(new databases) on all of the configured databases(nodes) in <code class="python"><span class="name">settings</span><span class="operator">.</span><span class="name">DATABASES</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>migrate_shards:</dt>
<dd><ul class="first last simple">
<li>this command will migrate all your application's models to all of the logical shards created with &quot;create_shards&quot;</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>drop_constraints:</dt>
<dd><ul class="first last simple">
<li>this command will drop all the foreign key constraints from the &quot;default&quot; database that have a relation with your &quot;ShardedModel&quot;</li>
</ul>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="settings">
<h1>Settings</h1>
<p>The settings are isolated into a single dict in your settings.py file like so:</p>
<pre class="code python literal-block">
<span class="name">DJANGO_AUTOSHARD</span> <span class="operator">=</span> <span class="punctuation">{</span>
    <span class="literal string">'EPOCH'</span><span class="punctuation">:</span> <span class="literal string">'2016-01-01'</span><span class="punctuation">,</span>
    <span class="literal string">'MAX_SHARDS'</span><span class="punctuation">:</span> <span class="literal number integer">1000</span><span class="punctuation">,</span>
<span class="punctuation">}</span>
</pre>
<p><code class="python"><span class="name">EPOCH</span></code> - defaults to <code class="python"><span class="literal string">'2016-01-01'</span></code>. Must be in <code class="python"><span class="literal string">'%Y-%m-</span><span class="literal string interpol">%d</span><span class="literal string">'</span></code> format.</p>
<p><code class="python"><span class="name">MAX_SHARDS</span></code> - defaults to <code class="python"><span class="literal number integer">8192</span></code>. This should NEVER be changed after initial setup, unless you want to rehash all your sharded data.</p>
</div>
<div class="section" id="caveats">
<h1>Caveats</h1>
<ul class="simple">
<li>you will no longer be able to use database joins between your sharded models, but you can still use joins on models that are related to your sharded model(models on the same shard as the user)</li>
<li>models that come from third party apps that are related to your sharded model and you don't have any control over, will need to have their foreign key dropped(use <code class="python"><span class="name">drop_constraints</span></code> command).</li>
<li>instead of using <code class="python"><span class="name">Book</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">create</span><span class="punctuation">(</span><span class="operator">...</span><span class="punctuation">)</span></code> you will have to use <code class="python"><span class="name">book</span> <span class="operator">=</span> <span class="name">Book</span><span class="punctuation">(</span><span class="operator">...</span><span class="punctuation">)</span></code> and then <code class="python"><span class="name">book</span><span class="operator">.</span><span class="name">save</span><span class="punctuation">()</span></code>. This is because of how Django model managers work.</li>
</ul>
</div>
<div class="section" id="todo">
<h1>TODO</h1>
<ul class="simple">
<li>Add replicas support</li>
<li>Create shard migration script</li>
<li>Create a benchmarking script</li>
<li>Add more tests</li>
<li>Test against Postgresql and Oracle</li>
</ul>
</div>
<div class="section" id="change-log">
<h1>Change Log</h1>
<div class="section" id="alpha-2016-04-02">
<h2>1.0(alpha) [2016-04-02]</h2>
<ul class="simple">
<li>Initial release.</li>
</ul>
</div>
</div>
</div>
</body>
</html>
